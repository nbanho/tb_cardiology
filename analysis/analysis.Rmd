---
title: "Analysis"
author: "Nicolas Banholzer"
date: "2023-07-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "..")
```

## Libraries

```{r libraries}
library(tidyverse)
library(haven)
library(reshape2)
library(rstanarm)
library(brms)
library(tidybayes)
library(ggalluvial)
library(mice)
library(mitools)
library(norm)
library(miceafter)
library(multcomp)
source("utils/plotting.r")
source("utils/tex.r")
```

```{r functions}
# ci of proportion
prop_ci <- function(p, N) {
  se <- sqrt(p * (1 - p) / N)
  l <- p - qnorm(0.975) * se
  u <- p + qnorm(0.975) * se
  return(c(l, u))
}

# edit pvalue
write_pvalue <- function(x) {
  if (x < 0.01) {
    return("p<0.001")
  } else {
    return(paste0("p=", round_k(x, 2)))
  }
}
```

## Data

```{r data}
df <- readRDS("data-clean/echo.rds") %>%
  group_by(record_id) %>%
  filter(any(event_time == "Start")) %>%
  ungroup() %>%
  mutate(
    diast_hep_rev = grepl("hepatic", note, ignore.case = TRUE),
    diast_hep_rev = ifelse(diast_hep_rev, "Yes", "No"),
    ann_rev = e_septal / e_lateral,
    ann_rev = ifelse(ann_rev > 0.9, "Yes", "No"),
    e_a = ifelse(mv_e_a > 1.5, "Yes", "No"),
    dt = ifelse(mv_dec_time < 160, "Yes", "No"),
    ivc_mm = ifelse(dilated_ivc == 1, "Yes", "No"),
    ivc_var = ifelse(ivc_low_respiratory_change == 1, "Yes", "No"),
    abnormal_mitral_inflow = ifelse(abnormal_mitral_inflow == 1, "Yes", "No"),
    septal_bounce = ifelse(septal_bounce == 1, "Yes", "No"),
    ivs_shift = ifelse(ivs_shift == 1, "Yes", "No"),
    sign_1 = ifelse(
      e_a == "Yes" & dt == "Yes" &
        (ivc_mm == "Yes" | ivc_var == "Yes"),
      "Yes", "No"
    ),
    sign_2 = abnormal_mitral_inflow,
    sign_3 = ifelse(
      ivs_shift == "Yes" | septal_bounce == "Yes",
      "Yes", "No"
    ),
    sign_4 = ann_rev,
    sign_5 = diast_hep_rev,
    across(
      c(starts_with("sign_")),
      ~ factor(.x, levels = c("Yes", "No"))
    )
  )


all_outcomes <- c(
  "pericard_effusion" = "Pericardial\neffusion",
  "pericard_thickening" = "Pericardial\nthickening",
  "pericardial_calc" = "Pericardial\ncalcification",
  "constriction_sign" = "Signs of\nconstriction",
  "constriction" = "Definite\nconstriction"
)
all_outcomes_nl <- c(
  "pericard_effusion" = "Pericardial effusion",
  "pericard_thickening" = "Pericardial thickening",
  "pericardial_calc" = "Pericardial calcification",
  "constriction_sign" = "Signs of constriction",
  "constriction" = "Definite constriction"
)

nrow(filter(df, event_time == "Start"))
nrow(filter(df, event_time == "End"))
nrow(filter(df, event_time == "Post"))
n_distinct(df$record_id)
```


## Tables

### Table 1

```{r patient-characteristics}
df_base_char <- df %>%
  group_by(record_id) %>%
  slice(1) %>%
  ungroup()

char_vars <- c(
  "Gender" = "sex",
  "Median age (years)" = "age",
  "Site" = "site",
  "BMI (kg/m2)" = "bmi",
  "Obesity (BMI > 30kg/m2)" = "obesity",
  "Underweight (BMI < 18kg/m2)" = "underweight",
  "6min walk-test distance (m)" = "smwt_distance_nr",
  "Sit-to-stand test (repetitions per min)" = "fa_sit_to_stand_nr",
  "Systolic Blood Pressure (mmHg)" = "ce_sys_blpress_nr",
  "Diastolic Blood Pressure (mmHg)" = "ce_dia_blpress_nr",
  "HIV infection status" = "hiv",
  "Median CD4 cell count (mm3)" = "hiv_cd4_mm3_nr",
  "HIV viral load (copies/mL)" = "hiv_viral_load",
  "Relapse TB case" = "tbd_pat_cat",
  "Cavitary disease" = "cavity",
  "TB drug resistance" = "drugresistant",
  "TB manifestation" = "tbd_diagnosis",
  "Smoking" = "sm_smoking_yn",
  "History of hypertension" = "mh_hypertension_yn",
  "Level of CRP (mg/l)" = "lab_creactive_prot_nr",
  "Level of neutrophils (G/I)" = "lab_neutrophils_nr",
  "Level of lymphocytes (G/I)" = "lab_lymphocytes_nr",
  "Level of eosinophiles (G/I)" = "lab_eosinophils_nr",
  "Level of Hb (g/dl)" = "lab_hemoglobin_nr"
)

char_digits <- c(
  "sex" = NA,
  "age" = 0,
  "site" = NA,
  "bmi" = 1,
  "obesity" = NA,
  "smwt_distance_nr" = 0,
  "fa_sit_to_stand_nr" = 0,
  "ce_sys_blpress_nr" = 0,
  "ce_dia_blpress_nr" = 0,
  "hiv" = NA,
  "hiv_cd4_mm3_nr" = 0,
  "hiv_viral_load" = 0,
  "tbd_pat_cat" = NA,
  "cavity" = NA,
  "drugresistant" = NA,
  "tbd_diagnosis" = NA,
  "sm_smoking_yn" = NA,
  "mh_hypertension_yn" = NA,
  "lab_creactive_prot_nr" = 2,
  "lab_neutrophils_nr" = 2,
  "lab_lymphocytes_nr" = 2,
  "lab_eosinophils_nr" = 2,
  "lab_hemoglobin_nr" = 2
)

baseline_tab <- tibble(variable = character(), value = character())

for (var in char_vars) {
  print(var)
  if (is.numeric(df_base_char[[var]])) {
    n_dig <- char_digits[var]
    val <- paste0(
      round_k(median(df_base_char[[var]], na.rm = TRUE), n_dig),
      " (",
      round_k(quantile(df_base_char[[var]], .25, na.rm = TRUE), n_dig),
      " - ",
      round_k(quantile(df_base_char[[var]], .75, na.rm = TRUE), n_dig),
      ")"
    )
    new_row <- tibble(
      variable = names(char_vars)[char_vars == var],
      value = val
    )
  } else if (is.factor(df_base_char[[var]])) {
    counts <- as.numeric(table(df_base_char[[var]]))
    perc_counts <- round(counts / sum(counts) * 100)
    val <- paste0(counts, " (", perc_counts, "%)")
    names_counts <- names(table(df_base_char[[var]]))
    new_row <- tibble(
      variable = c(
        names(char_vars)[char_vars == var],
        paste0("   ", names_counts)
      ),
      value = c("", val)
    )
  } else if (is.character(df_base_char[[var]])) {
    new_row <- tibble(
      variable = c("", names(char_vars)[char_vars == var]),
      value = c("", "")
    )
  } else {
    stop(sprintf("Incorrect variable type for %s", var))
  }
  baseline_tab <- rbind(baseline_tab, new_row)
}

# manually add third subcategory for hiv status
hiv_p <- df_base_char$hiv_cd4_mm3_nr[df_base_char$hiv == "Positive"]
hiv_p <- ifelse(is.na(hiv_p), "Unknown",
  ifelse(hiv_p < 350, "HIV++ (CD4 <350/mm3)", "HIV+ (CD4>=350/mm3)")
)
hiv_p <- factor(
  hiv_p,
  levels = c(
    "HIV++ (CD4 <350/mm3)",
    "HIV+ (CD4>=350/mm3)",
    "Unknown"
  )
)
hiv_p_count <- as.numeric(table(hiv_p))
hiv_p_perc <- round(hiv_p_count / sum(hiv_p_count) * 100, 0)
hiv_p_row <- tibble(
  variable = paste0("      ", levels(hiv_p)),
  value = paste0(hiv_p_count, " (", hiv_p_perc, "%)")
)
hiv_p_row_idx <- which(grepl("Positive", baseline_tab$variable))
baseline_tab <- rbind(
  baseline_tab[1:hiv_p_row_idx, ],
  hiv_p_row,
  baseline_tab[(hiv_p_row_idx + 1):nrow(baseline_tab), ]
)

# manually add HIV-RNA viral load if detectable
nnan_hiv_vl <- !is.na(df_base_char$hiv_viral_load)
det_hiv_vl <- df_base_char$hiv_viral_load == "Detectable"
hiv_viral_load <- df_base_char$hiv_viral_load_nr[nnan_hiv_vl & det_hiv_vl]
hiv_viral_load_val <- paste0(
  round_k(median(hiv_viral_load, na.rm = TRUE), 0),
  " (", round_k(quantile(hiv_viral_load, .25, na.rm = TRUE), 0),
  " - ", round_k(quantile(hiv_viral_load, .75, na.rm = TRUE), 0), ")"
)
hiv_viral_load_row <- tibble(
  variable = paste0("      ", "Median HIV-RNA viral load (copies/mL)"),
  value = hiv_viral_load_val
)
hiv_viral_load_row_idx <- which(grepl("Detectable", baseline_tab$variable))
baseline_tab <- rbind(
  c("variable" = "Variable", "value" = paste0("N=", nrow(df_base_char))),
  baseline_tab[1:hiv_viral_load_row_idx, ],
  hiv_viral_load_row,
  baseline_tab[(hiv_viral_load_row_idx + 1):nrow(baseline_tab), ]
)

write.table(
  data.frame(baseline_tab),
  file = "results/table-1-baseline.txt",
  row.names = FALSE, col.names = FALSE,
  sep = ",", quote = FALSE
)
```


### Table 2

```{r echo-results}
echo_vars <- c(
  "Abnormal LV geometry" = "abnormal_lv_geometry",
  "Type of abnormal LV geometry" = "type_lv_geometry_anomaly",
  "Aortic root dilation" = "aortic_dilation",
  "Ascending aorta dilation" = "asc_aorta_dilation",
  "Relevant aortic valve disease" = "av_disease",
  "   Aortic stenosis" = "as",
  "   Aortic regurgitation" = "ar",
  "Relevant mitral valve disease" = "mv_disease",
  "   Mitral stenosis" = "ms",
  "   Mitral regurgitation" = "mr",
  "Relevant tricuspid valve disease" = "tv_disease",
  "   Tricuspid stenosis" = "ts",
  "   Tricuspid regurgitation" = "tr",
  "LVEF (visually assessed)" = "lvef_visual",
  "LVEF (Simpson BP)" = "lvef_simpson",
  "LV systolic dysfunction" = "lv_systolic_dysfunction",
  "Diastolic dysfunction according to new guidelines" = "diastolic_dysfunction_new",
  "   Type of dysfunction" = "typ_diastolic_dysfunction_new",
  "LV dilation" = "lv_dilatation",
  "LA dilation" = "la_dilation",
  "RV dilation" = "rv_dilation",
  "TAPSE" = "rv_function",
  "TV annulus DTI S'" = "tv_dti",
  "RV FAC" = "fac",
  "RV longitudinal dysfunction" = "rv_long_dysf",
  "RV radial dysfunction" = "rv_rad_dysf",
  "RV/RA Gradient" = "tr_pgmax",
  "RA dilation" = "ra_dilation",
  "Pericardial effusion" = "pericard_effusion",
  "Type of pericardial effusion" = "pericard_effusion_importance",
  "Pericardial thickening" = "pericard_thickening",
  "Pericardial calcification" = "pericardial_calc",
  "Signs of constrictions" = "constriction_sign",
  "   Sign 1" = "sign_1",
  "   Sign 2" = "sign_2",
  "   Sign 3" = "sign_3",
  "   Sign 4" = "sign_4",
  "   Sign 5" = "sign_5",
  "Definitive constrictions" = "constriction",
  "Estimated central venous pressure" = "cvp"
)
echo_digits <- c(
  "abnormal_lv_geometry" = NA,
  "type_lv_geometry_anomaly" = NA,
  "aortic_dilation" = NA,
  "asc_aorta_dilation" = NA,
  "av_disease" = NA,
  "as" = NA,
  "ar" = NA,
  "mv_disease" = NA,
  "ms" = NA,
  "mr" = NA,
  "tv_disease" = NA,
  "ts" = NA,
  "tr" = NA,
  "lvef_visual" = 1,
  "lvef_simpson" = 1,
  "lv_systolic_dysfunction" = NA,
  "diastolic_dysfunction_new" = NA,
  "typ_diastolic_dysfunction_new" = NA,
  "lv_dilatation" = NA,
  "la_dilation" = NA,
  "rv_dilation" = NA,
  "rv_function" = 1,
  "tv_dti" = 1,
  "fac" = 1,
  "rv_long_dysf" = NA,
  "rv_rad_dysf" = NA,
  "tr_pgmax" = 1,
  "ra_dilation" = NA,
  "pericard_effusion" = NA,
  "pericard_effusion_importance" = NA,
  "pericard_thickening" = NA,
  "pericardial_calc" = NA,
  "constriction_sign" = NA,
  "sign_1" = NA,
  "sign_2" = NA,
  "sign_3" = NA,
  "sign_4" = NA,
  "sign_5" = NA,
  "constriction" = NA,
  "cvp" = 0
)

echo_tab <- tibble(variable = character(), value = character())

fill_tab <- function(dat, tab) {
  for (var in echo_vars) {
    if (is.numeric(dat[[var]])) {
      n_dig <- echo_digits[var]
      val_med <- round_k(median(dat[[var]], na.rm = TRUE), n_dig)
      val_med <- ifelse((val_med == "NA"), "-", val_med)
      val_low <- round_k(quantile(dat[[var]], .25, na.rm = TRUE), n_dig)
      val_low <- ifelse((val_low == "NA"), "-", val_low)
      val_up <- round_k(quantile(dat[[var]], .75, na.rm = TRUE), n_dig)
      val_up <- ifelse((val_up == "NA"), "-", val_up)
      val <- paste0(val_med, " (", val_low, " - ", val_up, ")")
      new_row <- tibble(
        variable = names(echo_vars)[echo_vars == var],
        value = val
      )
    } else if (is.factor(dat[[var]])) {
      if (length(table(dat[[var]])) == 2) {
        yes_count <- sum(dat[[var]] == "Yes", na.rm = TRUE)
        no_count <- sum(dat[[var]] == "No", na.rm = TRUE)
        tot_count <- yes_count + no_count
        perc_count <- round(yes_count / (yes_count + no_count) * 100, 0)
        perc_count <- ifelse(is.na(perc_count), "", perc_count)
        val <- paste0(yes_count, " / ", tot_count, " (", perc_count, "%)")
        new_row <- tibble(
          variable = names(echo_vars)[echo_vars == var],
          value = val
        )
      } else {
        counts <- as.numeric(table(dat[[var]]))
        perc_counts <- round(counts / sum(counts) * 100)
        perc_counts <- sapply(perc_counts, function(x) ifelse(is.na(x), "", x))
        val <- paste0(counts, " (", perc_counts, "%)")
        names_counts <- paste0("  ", names(table(dat[[var]])))
        new_row <- tibble(variable = names_counts, value = val)
      }
    } else if (is.character(dat[[var]])) {
      new_row <- tibble(
        variable = c("", names(echo_vars)[echo_vars == var]),
        value = c("", "")
      )
    } else {
      print(var)
      stop("Incorrect variable type")
    }
    tab <- rbind(tab, new_row)
  }
  return(tab)
}

echo_tab_base <- fill_tab(
  filter(df, event_time == "Start"),
  echo_tab
)
echo_tab_end <- fill_tab(
  filter(df, event_time == "End"),
  echo_tab
)
echo_tab_post <- fill_tab(
  filter(df, event_time == "Post"),
  echo_tab
)

echo_tab_joint <- cbind(
  echo_tab_base,
  echo_tab_end[, 2],
  echo_tab_post[, 2]
)

echo_tab_joint <- rbind(
  c(
    "Variable",
    paste0(
      "Start of treatment (N=",
      nrow(filter(df, event_time == "Start")),
      ")"
    ),
    paste0(
      "End of treatment (N=",
      nrow(filter(df, event_time == "End")),
      ")"
    ),
    paste0(
      "Post treatment (N=",
      nrow(filter(df, event_time == "Post")),
      ")"
    )
  ),
  echo_tab_joint
)

write.table(
  data.frame(echo_tab_joint),
  file = "results/table-2-echo.txt",
  row.names = FALSE, col.names = FALSE,
  sep = ",", quote = FALSE
)
```

### Supp Tables

```{r echo-by-hiv}
# subgroup at start
# by HIV
echo_tab_base_hiv_pos <- fill_tab(
  filter(df, event_time == "Start", hiv == "Positive"),
  echo_tab
)
echo_tab_base_hiv_neg <- fill_tab(
  filter(df, event_time == "Start", hiv == "Negative"),
  echo_tab
)
echo_tab_base_hiv <- cbind(
  echo_tab_base,
  echo_tab_base_hiv_pos[, 2],
  echo_tab_base_hiv_neg[, 2]
)

echo_tab_base_hiv <- rbind(
  c(
    "Variable",
    paste0(
      "Overall (N=",
      nrow(filter(df, event_time == "Start")),
      ")"
    ),
    paste0(
      "HIV positive (N=",
      nrow(filter(df, event_time == "Start", hiv == "Positive")),
      ")"
    ),
    paste0(
      "HIV negative (N=",
      nrow(filter(df, event_time == "Start", hiv == "Negative")),
      ")"
    )
  ),
  echo_tab_base_hiv
)

write.table(
  data.frame(echo_tab_base_hiv),
  file = "results/table-s1-echo-base-by-hiv.txt",
  row.names = FALSE, col.names = FALSE,
  sep = ",", quote = F
)


# subgroup at end
# by HIV
echo_tab_end_hiv_pos <- fill_tab(
  filter(df, event_time == "End", hiv == "Positive"),
  echo_tab
)
echo_tab_end_hiv_neg <- fill_tab(
  filter(df, event_time == "End", hiv == "Negative"),
  echo_tab
)
echo_tab_end_hiv <- cbind(
  echo_tab_end,
  echo_tab_end_hiv_pos[, 2],
  echo_tab_end_hiv_neg[, 2]
)

echo_tab_end_hiv <- rbind(
  c(
    "Variable",
    paste0(
      "Overall (N=",
      nrow(filter(df, event_time == "End")),
      ")"
    ),
    paste0(
      "HIV positive (N=",
      nrow(filter(df, event_time == "End", hiv == "Positive")),
      ")"
    ),
    paste0(
      "HIV negative (N=",
      nrow(filter(df, event_time == "End", hiv == "Negative")),
      ")"
    )
  ),
  echo_tab_end_hiv
)

write.table(
  data.frame(echo_tab_end_hiv),
  file = "results/table-s2-echo-end-by-hiv.txt",
  row.names = FALSE, col.names = FALSE,
  sep = ",", quote = FALSE
)
```

## Sankey post treatment

```{r sankey-post}
links_post <- df %>%
  group_by(record_id) %>%
  filter(any(event_time == "Post")) %>%
  ungroup() %>%
  dplyr::select(
    record_id,
    event_time,
    pericard_effusion,
    pericard_thickening,
    constriction_sign
  ) %>%
  mutate(
    across(
      c(
        pericard_effusion, pericard_thickening, constriction_sign
      ),
      as.character
    ),
    across(
      c(pericard_effusion, pericard_thickening, constriction_sign),
      ~ ifelse(is.na(.x), "Not determinable", .x)
    ),
    event_time = factor(
      event_time,
      levels = c("Start", "End", "Post")
    )
  ) %>%
  group_by(record_id) %>%
  complete(event_time = levels(event_time)) %>%
  ungroup() %>%
  mutate(
    across(
      c(
        pericard_effusion, pericard_thickening, constriction_sign
      ),
      ~ ifelse(is.na(.x), "Missing follow-up visit", .x)
    )
  ) %>%
  melt(c("record_id", "event_time")) %>%
  rename(outcome = variable) %>%
  mutate(
    outcome = factor(
      outcome %>% fct_recode(
        "Pericardial effusion" = "pericard_effusion",
        "Pericardial thickening" = "pericard_thickening",
        "Signs of constrictions" = "constriction_sign"
      ),
      levels = c(
        "Pericardial effusion",
        "Pericardial thickening",
        "Signs of constrictions"
      )
    ),
    value = factor(value, levels = rev(c(
      "Yes",
      "Not determinable",
      "Missing follow-up visit",
      "No"
    ))),
    event_time = factor(
      event_time,
      levels = c("Start", "End", "Post")
    )
  ) %>%
  group_by(outcome, value, event_time) %>%
  mutate(n = n()) %>%
  ungroup()

links_post %>%
  dplyr::select(-n) %>%
  dcast(record_id + outcome ~ event_time, value.var = "value") %>%
  group_by(outcome, `Start`, `Post`) %>%
  summarize(n = n()) %>%
  ungroup()

flow_post_pl <- links_post %>%
  ggplot(aes(
    x = event_time,
    stratum = value,
    alluvium = record_id,
    fill = value,
    label = value
  )) +
  facet_wrap(~outcome, nrow = 1) +
  geom_flow(stat = "alluvium", lode.guidance = "rightleft") +
  geom_stratum() +
  geom_text(
    stat = "stratum",
    aes(label = after_stat(count)),
    size = 8 / cm(1)
  ) +
  scale_fill_manual(
    values = c(
      wes_palette("FrenchDispatch")[2],
      wes_palette("FrenchDispatch")[3],
      "grey50",
      wes_palette("FrenchDispatch")[4]
    ),
    breaks = c("Yes", "Not determinable", "Missing follow-up visit", "No")
  ) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.01))) +
  labs(x = "Treatment", y = "Number of patients") +
  theme_custom() +
  theme(
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.key.width = unit(0.35, "cm"),
    legend.key.height = unit(0.4, "cm")
  )

save_plot(
  flow_post_pl,
  pdf_file = "results/sankey-post.pdf",
  w = 16, h = 10
)
```

## Pericardial abnormalities

```{r pathologies-proportions}
pericard_pl <- df %>%
  filter(event_time %in% c("Start", "End")) %>%
  dplyr::select(
    event_time,
    pericard_effusion,
    pericard_thickening,
    pericardial_calc,
    constriction_sign,
    constriction
  ) %>%
  set_names(c("event_time", all_outcomes)) %>%
  melt("event_time") %>%
  mutate(
    value = as.character(value),
    value = ifelse(is.na(value), "Not determinable", value),
    value = factor(value, levels = c("No", "Not determinable", "Yes"))
  ) %>%
  group_by(event_time, variable, value) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(event_time, variable) %>%
  mutate(p = 100 * n / sum(n)) %>%
  ungroup() %>%
  mutate(
    variable = factor(
      variable,
      levels = all_outcomes
    ),
    event_time = factor(
      event_time,
      levels = c("Start", "End")
    )
  ) %>%
  ggplot(aes(x = event_time, y = p, fill = value)) +
  geom_bar(stat = "identity", position = position_stack(), width = .7) +
  facet_wrap(~variable, nrow = 1) +
  labs(y = "Proportion of participants (%)", x = "Treatment") +
  scale_y_continuous(expand = c(0, 0)) +
  scale_fill_manual(
    values = wes_palette("FrenchDispatch")[2:4],
    breaks = c("Yes", "Not determinable", "No")
  ) +
  theme_custom() +
  theme(
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.key.width = unit(0.35, "cm"),
    legend.key.height = unit(0.4, "cm")
  )

save_plot(
  pericard_pl,
  pdf_file = "results/pericardial_pathologies.pdf",
  w = 16, h = 10
)
```

## Any abnormality

```{r any-abnormality}
# all patients
df %>%
  filter(event_time %in% c("Start", "End")) %>%
  rowwise() %>%
  mutate(any_abnorm = any(c_across(names(all_outcomes)) == "Yes")) %>%
  ungroup() %>%
  group_by(event_time) %>%
  summarize(
    n = sum(any_abnorm, na.rm = TRUE),
    N = n(),
    p = n / N
  ) %>%
  ungroup() %>%
  mutate(p = round(p * 100))

# paired patients
df %>%
  filter(event_time %in% c("Start", "End")) %>%
  group_by(record_id) %>%
  filter(n() == 2) %>%
  ungroup() %>%
  rowwise() %>%
  mutate(any_abnorm = any(c_across(names(all_outcomes)) == "Yes")) %>%
  ungroup() %>%
  group_by(event_time) %>%
  summarize(
    n = sum(any_abnorm, na.rm = TRUE),
    N = n(),
    p = n / N
  ) %>%
  ungroup() %>%
  mutate(p = round(p * 100))

# death patients
death_comp <- df %>%
  filter(event_time == "Start") %>%
  group_by(record_id) %>%
  summarize(
    any_abnorm = any(c_across(names(all_outcomes)) == "Yes", na.rm = TRUE),
    death_yn = max(death_yn)
  ) %>%
  ungroup() %>%
  mutate(
    any_abnorm = ifelse(any_abnorm, 1, 0),
    death_yn = ifelse(death_yn == 1, "Yes", "No"),
    death_yn = factor(death_yn, levels = c("No", "Yes"))
  )

table(death_comp$death_yn, death_comp$any_abnorm, useNA = "always")

mod_comp <- glm(
  any_abnorm ~ death_yn,
  family = binomial(),
  data = death_comp
)

summary(mod_comp)
```


## Treatment comparison

### All patients - imputed analysis

```{r pericardial-changes}
# subset primary outcomes
df_sub <- df %>%
  filter(event_time %in% c("Start", "End")) %>%
  dplyr::select(
    record_id,
    event_time,
    constriction_sign,
    constriction,
    pericard_effusion,
    pericard_thickening,
    pericardial_calc,
    site,
    age_cat25, sex,
    clindiag, cavity,
    hiv, tbd_pat_cat,
    drugresistant
  ) %>%
  mutate(
    across(c(
      constriction_sign,
      constriction,
      pericard_effusion,
      pericard_thickening,
      pericardial_calc
    ), ~ ifelse(.x == "Yes", 1, 0)),
    event_time = factor(
      event_time,
      levels = c("Start", "End")
    )
  )


# impute data
df_imp <- mice(
  data = dplyr::select(df_sub, -record_id),
  m = 100,
  seed = 12345
)

# compare proportions
imp_res_all <- tibble(
  outcome = c(),
  prop_m_start = c(),
  prop_l_start = c(),
  prop_u_start = c(),
  prop_m_end = c(),
  prop_l_end = c(),
  prop_u_end = c(),
  prop_m_diff = c(),
  prop_l_diff = c(),
  prop_u_diff = c(),
  pval_diff = c()
)

df_imp_long <- complete(df_imp, action = "long") %>%
  mutate(event_time = as.integer(event_time) - 1)
imp <- df2milist(df_imp_long, impvar = ".imp")
imp_start <- df2milist(filter(df_imp_long, event_time == 0), impvar = ".imp")
imp_end <- df2milist(filter(df_imp_long, event_time == 1), impvar = ".imp")

for (out in names(all_outcomes)) {
  # estimate and compare proportions
  p0 <- with(imp_start, expr = prop_wald(as.formula(paste(out, "~ 1"))))
  p1 <- with(imp_end, expr = prop_wald(as.formula(paste(out, "~ 1"))))
  pd <- with(imp, expr = propdiff_wald(as.formula(paste(out, "~ event_time"))))

  # pool estimates
  p0_pool <- pool_prop_wald(p0)
  p1_pool <- pool_prop_wald(p1)
  pd_pool <- pool_propdiff_wald(pd)

  # pvalue
  pd_stat <- data.frame(do.call(rbind, pd$statistics))
  pd_scalars <- pool_scalar_RR(
    pd_stat$Prop.diff, pd_stat$SE,
    logit_trans = FALSE,
    dfcom = pd_stat$dfcom[1],
    statistic = TRUE
  )

  # append to results tibble
  imp_res_all <- rbind(
    imp_res_all,
    tibble(
      outcome = out,
      prop_m_start = p0_pool[1, "Prop Wald"],
      prop_l_start = p0_pool[1, "95%CI L"],
      prop_u_start = p0_pool[1, "95%CI U"],
      prop_m_end = p1_pool[1, "Prop Wald"],
      prop_l_end = p1_pool[1, "95%CI L"],
      prop_u_end = p1_pool[1, "95%CI U"],
      prop_m_diff = pd_pool[1, "Prop diff Wald"],
      prop_l_diff = pd_pool[1, "95 CI low"],
      prop_u_diff = pd_pool[1, "95 CI high"],
      pval_diff = pd_scalars$pval[1]
    )
  )
}

imp_res_all$pval_diff_txt <- sapply(imp_res_all$pval_diff, write_pvalue)
```

### All patients - complete case analysis

```{r pericardial-changes-fup-complete}
# compare proportions
cc_res_all <- tibble(
  outcome = c(),
  prop_m_start = c(),
  prop_l_start = c(),
  prop_u_start = c(),
  prop_m_end = c(),
  prop_l_end = c(),
  prop_u_end = c(),
  prop_m_diff = c(),
  prop_l_diff = c(),
  prop_u_diff = c(),
  pval_diff = c()
)

cc_prop <- df_sub %>%
  dplyr::select(event_time, names(all_outcomes)) %>%
  melt(c("event_time")) %>%
  group_by(variable, event_time) %>%
  summarise(
    n = sum(value, na.rm = TRUE),
    N = sum(!is.na(value)),
    p = n / N
  ) %>%
  ungroup() %>%
  arrange(variable, event_time)

for (out in names(all_outcomes)) {
  # estimate and compare proportions
  p0_N <- cc_prop$N[cc_prop$variable == out & cc_prop$event_time == "Start"]
  p1_N <- cc_prop$N[cc_prop$variable == out & cc_prop$event_time == "End"]
  pd <- prop.test(
    x = cc_prop$n[cc_prop$variable == out],
    n = cc_prop$N[cc_prop$variable == out],
    correct = FALSE
  )

  # append to results tibble
  cc_res_all <- rbind(
    cc_res_all,
    tibble(
      outcome = out,
      prop_m_start = pd$estimate[1],
      prop_l_start = prop_ci(pd$estimate[1], p0_N)[1],
      prop_u_start = prop_ci(pd$estimate[1], p0_N)[2],
      prop_m_end = pd$estimate[2],
      prop_l_end = prop_ci(pd$estimate[2], p1_N)[1],
      prop_u_end = prop_ci(pd$estimate[2], p1_N)[2],
      prop_m_diff = pd$estimate[2] - pd$estimate[1],
      prop_l_diff = pd$conf.int[1],
      prop_u_diff = pd$conf.int[2],
      pval_diff = pd$p.value
    )
  )
}

# formatting
cc_res_all$pval_diff_txt <- sapply(cc_res_all$pval_diff, write_pvalue)

# plot - data
cc_res_all_pldat <- cc_res_all %>%
  mutate(
    outcome = recode(outcome, !!!all_outcomes),
    outcome = factor(
      outcome,
      levels = all_outcomes
    )
  ) %>%
  dplyr::select(outcome, matches("_start"), matches("_end")) %>%
  pivot_longer(
    cols = -outcome,
    names_to = "variable",
    values_to = "value"
  ) %>%
  mutate(
    event_time = ifelse(grepl("start", variable), "Start", "End"),
    event_time = factor(
      event_time,
      levels = c("Start", "End")
    ),
    variable = gsub("_start|_end", "", variable)
  ) %>%
  pivot_wider(
    names_from = variable,
    values_from = value
  ) %>%
  arrange(outcome, event_time) %>%
  mutate(prop_l = ifelse(prop_l < 0, 0, prop_l), prop_u = ifelse(prop_u > 1, 1, prop_u))

# plot - position of pvalues on y-axis
pval_ypos <- cc_res_all_pldat %>%
  group_by(outcome) %>%
  summarize(
    p_pos = max(prop_u)
  ) %>%
  ungroup() %>%
  mutate(p_pos = p_pos + 0.025) %>%
  arrange(outcome) %>%
  pull(p_pos)

# plot
pl_comp <- cc_res_all_pldat %>%
  ggplot(aes(x = outcome, fill = event_time, y = prop_m)) +
  geom_bar(
    stat = "identity",
    position = position_dodge(width = .66),
    width = .5
  ) +
  geom_errorbar(
    aes(ymin = prop_l, ymax = prop_u),
    position = position_dodge(width = .66),
    width = .2
  ) +
  ggsignif::geom_signif(
    annotations = cc_res_all$pval_diff_txt,
    y_position = pval_ypos,
    xmin = c(.75, 1.75, 2.75, 3.75, 4.75),
    xmax = c(1.25, 2.25, 3.25, 4.25, 5.25),
    textsize = 8 / cm(1)
  ) +
  scale_y_continuous(
    breaks = scales::breaks_pretty(5),
    labels = function(x) scales::percent(x, suffix = ""),
    expand = expansion(mult = c(0, 0.025))
  ) +
  scale_x_discrete(labels = all_outcomes) +
  scale_fill_manual(
    values = c(
      wes_palette("FrenchDispatch")[2],
      wes_palette("Moonrise3")[2]
    )
  ) +
  coord_cartesian(ylim = c(0, NA), clip = "off") +
  labs(y = "Proportion (%)", x = "Pericardial changes") +
  theme_custom(8) +
  theme(
    legend.position = "bottom", legend.title = element_blank(),
    axis.title.x = element_blank(),
    plot.title = element_text(face = 1, size = 8, margin = margin(b = 20)),
    strip.text = element_text(face = 2),
    legend.key.height = unit(0.3, "cm"),
    legend.key.width = unit(0.5, "cm"),
    plot.margin = margin(l = 20, t = 5.5, b = 5.5, r = 5.5)
  )

save_plot(
  pl_comp,
  pdf_file = "results/pericardial-changes.pdf",
  w = 16, h = 8
)
```

```{r, isolated-constriction-signs}
df_constr <- df %>%
  filter(event_time %in% c("Start", "End")) %>%
  mutate(
    event_time = factor(
      event_time,
      levels = c("Start", "End")
    )
  ) %>%
  dplyr::select(
    event_time,
    starts_with("sign_")
  )

# compare proportions
cc_res_cs <- tibble(
  outcome = c(),
  prop_m_start = c(),
  prop_l_start = c(),
  prop_u_start = c(),
  prop_m_end = c(),
  prop_l_end = c(),
  prop_u_end = c(),
  prop_m_diff = c(),
  prop_l_diff = c(),
  prop_u_diff = c(),
  pval_diff = c()
)

cc_prob_cs <- df_constr %>%
  melt(c("event_time")) %>%
  group_by(variable, event_time) %>%
  summarise(
    n = sum(value == "Yes", na.rm = TRUE),
    N = sum(!is.na(value)),
    p = n / N
  ) %>%
  ungroup() %>%
  arrange(variable, event_time)

for (out in paste("sign", 1:5, sep = "_")) {
  # estimate and compare proportions
  p0_N <- cc_prob_cs$N[
    cc_prob_cs$variable == out &
      cc_prob_cs$event_time == "Start"
  ]
  p1_N <- cc_prob_cs$N[
    cc_prob_cs$variable == out &
      cc_prob_cs$event_time == "End"
  ]
  pd <- prop.test(
    x = cc_prob_cs$n[cc_prob_cs$variable == out],
    n = cc_prob_cs$N[cc_prob_cs$variable == out],
    correct = FALSE
  )

  # append to results tibble
  cc_res_cs <- rbind(
    cc_res_cs,
    tibble(
      outcome = out,
      prop_m_start = pd$estimate[1],
      prop_l_start = prop_ci(pd$estimate[1], p0_N)[1],
      prop_u_start = prop_ci(pd$estimate[1], p0_N)[2],
      prop_m_end = pd$estimate[2],
      prop_l_end = prop_ci(pd$estimate[2], p1_N)[1],
      prop_u_end = prop_ci(pd$estimate[2], p1_N)[2],
      prop_m_diff = pd$estimate[2] - pd$estimate[1],
      prop_l_diff = pd$conf.int[1],
      prop_u_diff = pd$conf.int[2],
      pval_diff = pd$p.value
    )
  )
}

# formatting
cc_res_cs$pval_diff_txt <- sapply(cc_res_cs$pval_diff, write_pvalue)
firstup <- function(x) {
  substr(x, 1, 1) <- toupper(substr(x, 1, 1))
  x
}

# plot - data
cc_res_cs_pldat <- cc_res_cs %>%
  mutate(
    outcome = factor(
      gsub("_", " ", firstup(outcome)),
      levels = paste("Sign", 1:5)
    )
  ) %>%
  dplyr::select(outcome, matches("_start"), matches("_end")) %>%
  pivot_longer(
    cols = -outcome,
    names_to = "variable",
    values_to = "value"
  ) %>%
  mutate(
    event_time = ifelse(grepl("start", variable), "Start", "End"),
    event_time = factor(
      event_time,
      levels = c("Start", "End")
    ),
    variable = gsub("_start|_end", "", variable)
  ) %>%
  pivot_wider(
    names_from = variable,
    values_from = value
  ) %>%
  arrange(outcome, event_time) %>%
  mutate(prop_l = ifelse(prop_l < 0, 0, prop_l), prop_u = ifelse(prop_u > 1, 1, prop_u))

# plot - position of pvalues on y-axis
pval_ypos_cs <- cc_res_cs_pldat %>%
  group_by(outcome) %>%
  summarize(
    p_pos = max(prop_u)
  ) %>%
  ungroup() %>%
  mutate(p_pos = p_pos + 0.025) %>%
  arrange(outcome) %>%
  pull(p_pos)

# plot
pl_comp_cs <- cc_res_cs_pldat %>%
  ggplot(aes(x = outcome, fill = event_time, y = prop_m)) +
  geom_bar(
    stat = "identity",
    position = position_dodge(width = .66),
    width = .5
  ) +
  geom_errorbar(
    aes(ymin = prop_l, ymax = prop_u),
    position = position_dodge(width = .66),
    width = .2
  ) +
  ggsignif::geom_signif(
    annotations = cc_res_cs$pval_diff_txt,
    y_position = pval_ypos_cs,
    xmin = c(.75, 1.75, 2.75, 3.75, 4.75),
    xmax = c(1.25, 2.25, 3.25, 4.25, 5.25),
    textsize = 8 / cm(1)
  ) +
  scale_y_continuous(
    breaks = scales::breaks_pretty(5),
    labels = function(x) scales::percent(x, suffix = ""),
    expand = expansion(mult = c(0, 0.025))
  ) +
  scale_fill_manual(
    values = c(
      wes_palette("FrenchDispatch")[2],
      wes_palette("Moonrise3")[2]
    )
  ) +
  coord_cartesian(ylim = c(0, NA), clip = "off") +
  labs(y = "Proportion (%)", x = "Signs of constrictions") +
  theme_custom(8) +
  theme(
    legend.position = "bottom", legend.title = element_blank(),
    axis.title.x = element_blank(),
    plot.title = element_text(face = 1, size = 8, margin = margin(b = 20)),
    strip.text = element_text(face = 2),
    legend.key.height = unit(0.3, "cm"),
    legend.key.width = unit(0.5, "cm"),
    plot.margin = margin(l = 20, t = 5.5, b = 5.5, r = 5.5)
  )

save_plot(
  pl_comp_cs,
  pdf_file = "results/constriction-signs-changes.pdf",
  w = 16, h = 8
)

# table
cc_res_cs_tab <- cc_prob_cs %>%
  mutate(freq = paste(n, " / ", N, " (", round(p * 100), "%)", sep = "")) %>%
  dplyr::select(variable, event_time, freq) %>%
  spread(event_time, freq) %>%
  mutate(
    pval = cc_res_cs$pval_diff_txt,
    pval = gsub("p|=", "", pval),
    variable = paste("Sign", 1:5)
  )

write.table(
  cc_res_cs_tab,
  file = "results/table-s3-constriction-signs.txt",
  row.names = FALSE, col.names = FALSE,
  sep = ",", quote = FALSE
)
```

### FUP Patients - imputed analysis

```{r pericardial-changes-fup}
# subset primary outcomes
df_sub_fup <- df %>%
  filter(event_time %in% c("Start", "End")) %>%
  group_by(record_id) %>%
  filter(n() == 2) %>%
  ungroup() %>%
  dplyr::select(
    record_id,
    event_time,
    constriction_sign,
    constriction,
    pericard_effusion,
    pericard_thickening,
    pericardial_calc,
    site,
    age_cat25, sex,
    clindiag, cavity,
    hiv, tbd_pat_cat,
    drugresistant
  ) %>%
  mutate(
    across(c(
      constriction_sign,
      constriction,
      pericard_effusion,
      pericard_thickening,
      pericardial_calc
    ), ~ ifelse(.x == "Yes", 1, 0)),
    event_time = factor(
      event_time,
      levels = c("Start", "End")
    )
  )

# impute data
df_imp_fup <- mice(
  data = dplyr::select(df_sub_fup, -record_id),
  m = 100,
  seed = 12345
)

# compare proportions
imp_res_fup <- tibble(
  outcome = c(),
  prop_m_start = c(),
  prop_l_start = c(),
  prop_u_start = c(),
  prop_m_end = c(),
  prop_l_end = c(),
  prop_u_end = c(),
  prop_m_diff = c(),
  prop_l_diff = c(),
  prop_u_diff = c(),
  pval_diff = c()
)

df_imp_fup_long <- complete(df_imp_fup, action = "long") %>%
  mutate(event_time = as.integer(event_time) - 1)
imp_fup <- df2milist(df_imp_fup_long, impvar = ".imp")
imp_fup_start <- df2milist(filter(df_imp_fup_long, event_time == 0), impvar = ".imp")
imp_fup_end <- df2milist(filter(df_imp_fup_long, event_time == 1), impvar = ".imp")

for (out in names(all_outcomes)) {
  # estimate and compare proportions
  p0 <- with(imp_fup_start, expr = prop_wald(as.formula(paste(out, "~ 1"))))
  p1 <- with(imp_fup_end, expr = prop_wald(as.formula(paste(out, "~ 1"))))
  pd <- with(imp_fup, expr = propdiff_wald(as.formula(paste(out, "~ event_time"))))

  # pool estimates
  p0_pool <- pool_prop_wald(p0)
  p1_pool <- pool_prop_wald(p1)
  pd_pool <- pool_propdiff_wald(pd)

  # pvalue
  pd_stat <- data.frame(do.call(rbind, pd$statistics))
  pd_scalars <- pool_scalar_RR(
    pd_stat$Prop.diff, pd_stat$SE,
    logit_trans = FALSE,
    dfcom = pd_stat$dfcom[1],
    statistic = TRUE
  )

  # append to results tibble
  imp_res_fup <- rbind(
    imp_res_fup,
    tibble(
      outcome = out,
      prop_m_start = p0_pool[1, "Prop Wald"],
      prop_l_start = p0_pool[1, "95%CI L"],
      prop_u_start = p0_pool[1, "95%CI U"],
      prop_m_end = p1_pool[1, "Prop Wald"],
      prop_l_end = p1_pool[1, "95%CI L"],
      prop_u_end = p1_pool[1, "95%CI U"],
      prop_m_diff = pd_pool[1, "Prop diff Wald"],
      prop_l_diff = pd_pool[1, "95 CI low"],
      prop_u_diff = pd_pool[1, "95 CI high"],
      pval_diff = pd_scalars$pval[1]
    )
  )
}

# formatting
imp_res_fup$pval_diff_txt <- sapply(imp_res_fup$pval_diff, write_pvalue)
```

### FUP Patients - complete case analysis

```{r pericardial-changes-fup-complete}
# compare proportions
cc_res_fup <- tibble(
  outcome = c(),
  prop_m_start = c(),
  prop_l_start = c(),
  prop_u_start = c(),
  prop_m_end = c(),
  prop_l_end = c(),
  prop_u_end = c(),
  prop_m_diff = c(),
  prop_l_diff = c(),
  prop_u_diff = c(),
  pval_diff = c()
)

cc_fup_prop <- df_sub_fup %>%
  dplyr::select(event_time, names(all_outcomes)) %>%
  melt(c("event_time")) %>%
  group_by(variable, event_time) %>%
  summarise(
    n = sum(value, na.rm = TRUE),
    N = sum(!is.na(value)),
    p = n / N
  ) %>%
  ungroup() %>%
  arrange(variable, event_time)

for (out in names(all_outcomes)) {
  # estimate and compare proportions
  p0_N <- cc_fup_prop$N[cc_fup_prop$variable == out & cc_fup_prop$event_time == "Start"]
  p1_N <- cc_fup_prop$N[cc_fup_prop$variable == out & cc_fup_prop$event_time == "End"]
  pd <- prop.test(
    x = cc_fup_prop$n[cc_fup_prop$variable == out],
    n = cc_fup_prop$N[cc_fup_prop$variable == out],
    correct = FALSE
  )

  # append to results tibble
  cc_res_fup <- rbind(
    cc_res_fup,
    tibble(
      outcome = out,
      prop_m_start = pd$estimate[1],
      prop_l_start = prop_ci(pd$estimate[1], p0_N)[1],
      prop_u_start = prop_ci(pd$estimate[1], p0_N)[2],
      prop_m_end = pd$estimate[2],
      prop_l_end = prop_ci(pd$estimate[2], p1_N)[1],
      prop_u_end = prop_ci(pd$estimate[2], p1_N)[2],
      prop_m_diff = pd$estimate[2] - pd$estimate[1],
      prop_l_diff = pd$conf.int[1],
      prop_u_diff = pd$conf.int[2],
      pval_diff = pd$p.value
    )
  )
}

# formatting
cc_res_fup$pval_diff_txt <- sapply(cc_res_fup$pval_diff, write_pvalue)
```

### Summary table

```{r overview-table}
prop_tbl_header <- rbind(
  c("", "", "Start of treatment", "", "End of treatment", "", "Comparison", ""),
  c("Abnormality", "", "Prop. in % (95%-CI)", "", "Prop. in % (95%-CI)", "", "Diff. (95%-CI)", "p-value")
)

prop_tbl_panels <- c(
  "Panel A: Complete case analysis of all patients",
  "Panel B: Imputed data analysis of all patients",
  "Panel C: Complete case analysis of patients with follow-up visits",
  "Panel D: Imputed data analysis of patients with follow-up visits"
)
prop_tbl_panels <- lapply(prop_tbl_panels, function(x) {
  c(x, rep("", 7))
})

res <- list(
  cc_res_all, imp_res_all,
  cc_res_fup, imp_res_fup
)
res <- lapply(res, function(x) {
  x %>%
    mutate(
      outcome = recode(outcome, !!!all_outcomes_nl),
      outcome = factor(
        outcome,
        levels = all_outcomes_nl
      ),
      across(c(-outcome, -pval_diff, -pval_diff_txt), ~ round(.x * 100)),
      pval_diff_txt = ifelse(pval_diff < 0.001, "<0.001", paste0("", round_k(pval_diff, 2)))
    ) %>%
    rowwise() %>%
    mutate(
      space_col0 = "",
      prop_start = paste0(prop_m_start, " (", prop_l_start, " – ", prop_u_start, ")"),
      space_col1 = "",
      prop_end = paste0(prop_m_end, " (", prop_l_end, " – ", prop_u_end, ")"),
      pace_col2 = "",
      prop_diff = paste0(prop_m_diff, " (", prop_l_diff, " – ", prop_u_diff, ")"),
    ) %>%
    ungroup() %>%
    dplyr::select(
      outcome, space_col0, prop_start, space_col1, prop_end, pace_col2, prop_diff, pval_diff_txt
    )
})

prop_tbl <- rbind(
  prop_tbl_header,
  prop_tbl_panels[[1]],
  as.matrix(res[[1]]),
  prop_tbl_panels[[2]],
  as.matrix(res[[2]]),
  prop_tbl_panels[[3]],
  as.matrix(res[[3]]),
  prop_tbl_panels[[4]],
  as.matrix(res[[4]])
)

write.table(
  prop_tbl,
  file = "results/tbl-pericardial-changes.txt",
  row.names = FALSE, col.names = FALSE,
  sep = ",", quote = FALSE
)
```


## Association with patient characteristics

### Complete case analysis

```{r association-complete}
cc_assoc <- tibble(
  type = character(),
  time = character(),
  outcome = character(),
  predictor = character(),
  mean = numeric(),
  lower = numeric(),
  upper = numeric(),
  pvalue = numeric()
)

sub_outcomes <- c(
  "pericard_effusion",
  "pericard_thickening",
  "constriction_sign"
)

predictors <- c(
  "age_cat25",
  "sex",
  "hiv",
  "tbd_pat_cat"
)
pred_cats <- paste0(
  predictors,
  sapply(predictors, function(x) levels(df[[x]])[2])
)
names(pred_cats) <- predictors
pred_cats_int <- paste0("event_timeEnd:", pred_cats)
names(pred_cats_int) <- predictors

for (out in sub_outcomes) {
  # multivariable model
  form <- as.formula(paste0(
    out, " ~ site + ",
    paste("event_time *", predictors, collapse = " + ")
  ))
  mod <- glm(form, data = df_sub, family = binomial())

  # association with baseline
  coef_start <- coef(mod)[pred_cats]
  se_start <- summary(mod)$coefficients[, "Std. Error"][pred_cats]
  pval_start <- summary(mod)$coefficients[, "Pr(>|z|)"][pred_cats]

  # association with end of treatment
  coef_end <- numeric()
  se_end <- numeric()
  pval_end <- numeric()
  for (i in 1:length(pred_cats)) {
    lin_hyp <- glht(
      model = mod,
      linfct = paste0(pred_cats[i], " + ", pred_cats_int[i], " = 0")
    )
    coef_end[i] <- summary(lin_hyp)$test$coefficients
    se_end[i] <- summary(lin_hyp)$test$sigma
    pval_end[i] <- summary(lin_hyp)$test$pvalues
  }

  cc_assoc <- rbind(
    cc_assoc,
    tibble(
      type = "Multivariable",
      time = "Start",
      outcome = out,
      predictor = predictors,
      mean = exp(coef_start),
      lower = exp(coef_start - qnorm(.975) * se_start),
      upper = exp(coef_start + qnorm(.975) * se_start),
      pvalue = pval_start
    ),
    tibble(
      type = "Multivariable",
      time = "End",
      outcome = out,
      predictor = predictors,
      mean = exp(coef_end),
      lower = exp(coef_end - qnorm(.975) * se_end),
      upper = exp(coef_end + qnorm(.975) * se_end),
      pvalue = pval_end
    )
  )

  for (pred in predictors) {
    # univariable model
    uni_form <- as.formula(
      paste0(
        out, " ~ site + ",
        paste("event_time *", pred, collapse = " + ")
      )
    )
    uni_mod <- glm(uni_form, data = df_sub, family = binomial())

    # association with baseline
    coef_start <- coef(uni_mod)[pred_cats[pred]]
    se_start <- summary(uni_mod)$coefficients[, "Std. Error"][pred_cats[pred]]
    pval_start <- summary(uni_mod)$coefficients[, "Pr(>|z|)"][pred_cats[pred]]

    # association with end of treatment
    lin_hyp <- glht(
      model = uni_mod,
      linfct = paste0(pred_cats[pred], " + ", pred_cats_int[pred], " = 0")
    )
    coef_end <- summary(lin_hyp)$test$coefficients
    se_end <- summary(lin_hyp)$test$sigma
    pval_end <- summary(lin_hyp)$test$pvalues

    cc_assoc <- rbind(
      cc_assoc,
      tibble(
        type = "Univariable",
        time = "Start",
        outcome = out,
        predictor = pred,
        mean = exp(coef_start),
        lower = exp(coef_start - qnorm(.975) * se_start),
        upper = exp(coef_start + qnorm(.975) * se_start),
        pvalue = pval_start
      ),
      tibble(
        type = "Univariable",
        time = "End",
        outcome = out,
        predictor = pred,
        mean = exp(coef_end),
        lower = exp(coef_end - qnorm(.975) * se_end),
        upper = exp(coef_end + qnorm(.975) * se_end),
        pvalue = pval_end
      )
    )
  }
}
```

```{r, association-table}
cc_assoc <- cc_assoc %>%
  mutate(
    mci = paste0(
      round_k(mean, 2),
      " (",
      round_k(lower, 2), " – ", round_k(upper, 2),
      ")"
    ),
    pvalue_txt = ifelse(pvalue < 0.01, "<0.01", paste0("", round_k(pvalue, 2)))
  )

predictor_levels <- matrix(c(
  "Age>=25", "Age<25",
  "Male", "Female",
  "HIV-", "HIV+",
  "New case", "Relapse case"
), ncol = 2, byrow = TRUE)

assoc_res <- matrix(
  "",
  nrow = (length(predictors) * 2 + 1) * length(sub_outcomes) + 2,
  ncol = 7
)

for (t in c("Start", "End")) {
  ki <- 0

  assoc_res[1, ] <- c(
    "Characteristic", "",
    "Univariable analysis", "", "",
    "Multivariable analysis", ""
  )
  assoc_res[2, ] <- c(
    " ", "",
    "OR (95%-CI)", "p-value", "",
    "OR (95%-CI)", "p-value"
  )

  ki <- 2
  for (k in 1:length(sub_outcomes)) {
    ki <- ki + 1
    assoc_res[ki, ] <- c(
      all_outcomes_nl[sub_outcomes[k]],
      rep("", ncol(assoc_res) - 1)
    )
    for (i in 1:length(predictors)) {
      ki <- ki + 1
      assoc_res[ki, ] <- c(
        paste0("   ", predictor_levels[i, 1]),
        "",
        "1 (reference)",
        "", "",
        "1 (reference)",
        ""
      )
      ki <- ki + 1
      assoc_res[ki, ] <- unname(c(
        paste0("   ", predictor_levels[i, 2]),
        "",
        cc_assoc %>%
          filter(
            predictor == predictors[i],
            type == "Univariable",
            outcome == sub_outcomes[k],
            time == t
          ) %>%
          pull(mci),
        cc_assoc %>%
          filter(
            predictor == predictors[i],
            type == "Univariable",
            outcome == sub_outcomes[k],
            time == t
          ) %>%
          pull(pvalue_txt),
        "",
        cc_assoc %>%
          filter(
            predictor == predictors[i],
            type == "Multivariable",
            outcome == sub_outcomes[k],
            time == t
          ) %>%
          pull(mci),
        cc_assoc %>%
          filter(
            predictor == predictors[i],
            type == "Multivariable",
            outcome == sub_outcomes[k],
            time == t
          ) %>%
          pull(pvalue_txt)
      ))
    }
  }
  write.table(
    assoc_res,
    file = paste0("results/tbl-association-", t, ".txt"),
    row.names = FALSE, col.names = FALSE,
    sep = ",", quote = FALSE
  )
}
```

### Imputed data

```{r association-imputed}
# associations results
est_assoc <- tibble(
  type = character(),
  time = character(),
  outcome = character(),
  predictor = character(),
  mean = numeric(),
  lower = numeric(),
  upper = numeric(),
  pvalue = numeric()
)

sub_outcomes <- c(
  "pericard_effusion",
  "pericard_thickening",
  "constriction_sign"
)

predictors <- c(
  "age_cat25",
  "sex",
  "hiv",
  "tbd_pat_cat"
)
pred_cats <- paste0(
  predictors,
  sapply(predictors, function(x) levels(df[[x]])[2])
)
pred_cats_int <- paste0("event_timeEnd:", pred_cats)


# function to compute pvalues in mitools
MIpvalues <- function(mod) {
  coefs <- MIextract(mod, fun = coefficients)
  se <- MIextract(mod, fun = vcov)
  se <- lapply(se, function(x) sqrt(diag(x)))
  res <- norm::mi.inference(coefs, se)
  return(res$signif)
}

for (out in sub_outcomes) {
  # estimate multivariable associations
  mult_form <- as.formula(paste0(
    out, " ~ site + ",
    paste("event_time *", predictors, collapse = " + ")
  ))
  mod_mult <- lapply(
    1:df_imp_fup$m, function(i) {
      glm(mult_form, data = complete(df_imp_fup, i), family = binomial())
    }
  )

  mult_pool <- MIcombine(mod_mult)
  mult_sum <- summary(mult_pool)
  coef <- mult_sum[pred_cats, "results"]
  se <- mult_sum[pred_cats, "se"]
  pv <- MIpvalues(mod_mult)[pred_cats]

  assoc_mult_start <- tibble(
    type = "Multivariable",
    time = "Start",
    outcome = out,
    predictor = predictors,
    mean = exp(coef),
    lower = exp(coef - qnorm(.975) * se),
    upper = exp(coef + qnorm(.975) * se),
    pvalue = pv
  )

  est_assoc <- rbind(est_assoc, assoc_mult_start)

  coef_et <- mult_sum[pred_cats_int, "results"]
  se_et <- mult_sum[pred_cats_int, "se"]
  coef_end <- coef + coef_et
  se_end <- numeric(length(coef_end))
  for (i in seq_along(coef_end)) {
    cov_i <- vcov(mult_pool)[pred_cats[i], pred_cats_int[i]]
    se_end[i] <- sqrt(se[i]^2 + se_et[i]^2 + 2 * cov_i)
  }

  pv_end <- numeric(length(coef_end))
  for (i in 1:length(predictors)) {
    predictors_neg <- predictors[!predictors %in% predictors[i]]
    m1 <- with(df_imp_fup, glm(as.formula(
      paste0(
        out, " ~ site + ",
        paste("event_time *", predictors_neg, collapse = " + ")
      )
    ), family = binomial()))
    m2 <- with(df_imp_fup, glm(as.formula(
      paste0(
        out, " ~ site + ",
        paste("event_time *", predictors, collapse = " + ")
      )
    ), family = binomial()))
    pv_end[i] <- summary(D1(m2, m1))$comparisons$p.value
  }

  assoc_mult_end <- tibble(
    type = "Multivariable",
    time = "End",
    outcome = out,
    predictor = predictors,
    mean = exp(coef_end),
    lower = exp(coef_end - qnorm(.975) * se_end),
    upper = exp(coef_end + qnorm(.975) * se_end),
    pvalue = pv_end
  )

  est_assoc <- rbind(est_assoc, assoc_mult_end)

  for (pred in predictors) {
    # estimate univariable association
    uni_form <- as.formula(
      paste0(
        out, " ~ site + ",
        paste("event_time *", pred, collapse = " + ")
      )
    )
    mod_uni <- lapply(
      1:df_imp_fup$m, function(i) {
        glm(uni_form, data = complete(df_imp_fup, i), family = binomial())
      }
    )

    term <- paste0(pred, levels(df[[pred]])[2])
    uni_pool <- MIcombine(mod_uni)
    uni_sum <- summary(uni_pool)
    coef <- uni_sum[term, "results"]
    se <- uni_sum[term, "se"]
    pv <- MIpvalues(mod_uni)[term]

    assoc_start <- tibble(
      type = "Univariable",
      time = "Start",
      outcome = out,
      predictor = pred,
      mean = exp(coef),
      lower = exp(coef - qnorm(.975) * se),
      upper = exp(coef + qnorm(.975) * se),
      pvalue = pv
    )

    est_assoc <- rbind(est_assoc, assoc_start)

    iterm <- paste0("event_timeEnd:", term)
    coef_et <- uni_sum[iterm, "results"]
    se_et <- uni_sum[iterm, "se"]
    coef_end <- coef + coef_et
    icov <- vcov(uni_pool)[term, iterm]
    se_end <- sqrt(se^2 + se_et^2 + 2 * icov)

    m1 <- with(df_imp_fup, glm(as.formula(
      paste(out, "~ site + event_time")
    ), family = binomial()))
    m2 <- with(df_imp_fup, glm(as.formula(
      paste(out, "~ site + event_time *", pred)
    ), family = binomial()))
    pv_end <- summary(D1(m2, m1))$comparisons$p.value

    assoc_end <- tibble(
      type = "Univariable",
      time = "End",
      outcome = out,
      predictor = pred,
      mean = exp(coef_end),
      lower = exp(coef_end - qnorm(.975) * se_end),
      upper = exp(coef_end + qnorm(.975) * se_end),
      pvalue = pv_end
    )

    est_assoc <- rbind(est_assoc, assoc_end)
  }
}

names(sub_outcomes) <- gsub("\n", " ", all_outcomes[sub_outcomes])
sub_outcomes <- setNames(names(sub_outcomes), sub_outcomes)
predictors <- setNames(c(
  "<25y",
  "Female",
  "HIV+",
  "Relapse"
), predictors)

est_assoc <- est_assoc %>%
  mutate(
    predictor = recode(predictor, !!!predictors),
    outcome = recode(outcome, !!!sub_outcomes),
    outcome = factor(
      outcome,
      levels = c(sub_outcomes)
    ),
    predictor = factor(
      predictor,
      levels = rev(predictors)
    ),
    time = factor(
      paste(time, "of treatment"),
      levels = paste(c("Start", "End"), "of treatment")
    ),
    type = factor(
      paste(type, "analysis"),
      levels = paste(c("Univariable", "Multivariable"), "analysis")
    )
  )

# plot
pl_assoc <- est_assoc %>%
  ggplot(aes(
    x = mean,
    xmin = lower,
    xmax = upper,
    y = predictor,
    color = type
  )) +
  facet_grid(outcome ~ time) +
  geom_vline(
    aes(xintercept = 1),
    linetype = "dotted", color = "grey30"
  ) +
  geom_errorbar(
    width = .5,
    position = position_dodge(width = .66)
  ) +
  geom_point(
    shape = 23, size = 1, fill = "white",
    position = position_dodge(width = .66),
  ) +
  scale_x_continuous(
    limits = c(0, NA),
    expand = c(0, 0)
  ) +
  scale_color_manual(
    values = wes_palette("Darjeeling2")[c(2, 5)]
  ) +
  labs(x = "Odds ratio") +
  theme_custom() +
  theme(
    axis.title.y = element_blank(),
    strip.text.x = element_text(face = 2, margin = margin(b = 10, t = 10)),
    legend.position = "bottom",
    legend.title = element_blank(),
    panel.spacing.y = unit(0.5, "lines")
  ) +
  guides(color = guide_legend(nrow = 1))

save_plot(
  pl_assoc,
  pdf_file = "results/association.pdf",
  w = 16, h = 23
)

est_assoc %>%
  mutate_if(is.numeric, round, 3) %>%
  arrange(type, time, outcome, predictor) %>%
  writexl::write_xlsx("results/association.xlsx")
```